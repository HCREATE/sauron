### CAP定理

> CAP原则又称CAP定理，指的是在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。

一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）。  
可用性（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性）。  
分区容错性（P）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。        

结论：因为分布式系统中含有多个节点，因此网络波动是不可避免的，因此要保证分区容错性（大前提），系统设计时只能选择一个目标（一致性或可用性）。如果追求一致性（CP），那么无法保证所有节点的可用性；如果追求所有节点的可用性（AP），那就没法做到一致性。

### BASE理论

BASE理论是对CAP理论的延伸，思想是即使无法做到强一致性（CAP的一致性就是强一致性），但可以采用适当的采取弱一致性，即最终一致性。

BASE是指基本可用（Basically Available）、软状态（ Soft State）、最终一致性（ Eventual Consistency）。    
BA: Basic Availability 基本业务可用性（支持分区失败）    
S: Soft state 柔性状态（状态允许有短时间不同步，异步）     
E: Eventual consistency 最终一致性（最终数据是一致的，但不是实时一致）    

>基本可用    
基本可用是指分布式系统在出现故障的时候，允许损失部分可用性（例如响应时间、功能上的可用性），允许损失部分可用性。需要注意的是，基本可用绝不等价于系统不可用。   
响应时间上的损失：正常情况下搜索引擎需要在0.5秒之内返回给用户相应的查询结果，但由于出现故障（比如系统部分机房发生断电或断网故障），查询结果的响应时间增加到了1~2秒。   
功能上的损失：购物网站在购物高峰（如双十一）时，为了保护系统的稳定性，部分消费者可能会被引导到一个降级页面。

>软状态   
软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据会有多个副本，允许不同副本同步的延时就是软状态的体现。mysql replication的异步复制也是一种体现。

>最终一致性    
最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。  

### 操作

可查询操作   

    服务操作的可标识性:   
        服务操作具有全局唯一标识    
        操作有唯一的、确定的时间(约定以谁的时间为准)    

幂等操作    

    重复调用多次产生的业务结果与调用一次产生的业务结果相同
    实现方式一    
        通过业务操作本身实现幂等性    
    实现方式二            
        系统缓存所有请求与处理结果 • 检测到重复请求之后，自动返回之前的处理结果

TCC操作

Try: 尝试执行业务

    • 完成所有业务检查(一致性)
    • 预留必须业务资源(准隔离性)
    
Confirm:确认执行业务   

    • 真正执行业务，不作任何业务检查
    • 只使用Try阶段预留的业务资源
    • Confirm操作要满足幂等性
    
Cancel: 取消执行业务

    • 释放Try阶段预留的业务资源
    • Cancel操作要满足幂等性
    
与2PC协议比较    

    • 位于业务服务层而非资源层
    • 没有单独的准备(Prepare)阶段， Try操作兼备资源操作与准备能力
    • Try操作可以灵活选择业务资源的 锁定粒度(以业务定粒度) • 较高开发成本


可补偿操作

    do: 真正执行业务
    • 完成业务处理
    • 业务执行结果外部可见

    compensate:业务补偿
    • 抵销(或部分抵销)正向业务操作的业务结果
    • 补偿操作满足幂等性

    约束
    • 补偿在业务上可行
    • 由于业务执行结果未隔离、或者补偿不完整带来的风险与成本可控
    
（TCC操作中的Confirm操作和Cancel操作，其实也可以看作是补偿操作）

### 解决方案

#####可靠消息最终一致性方案

>它通常没有像前面两种分布式事务解决方案那样有回滚或撤销数据的操作，而更多的是强调事务的补偿和重试。这里的可靠消息指的是消息队列中间件，消息队列其中一个特点就是消息可靠性，而该解决方案最终能达到事务一致，依靠的核心就是消息队列。它的优点是灵活度非常高，可以根据自己具体的业务场景做改变，同时，对比TCC来说，性能和吞吐量更高，并且对应用的侵入性更低。   
它的缺点是首先该解决方案设计过于复杂，组件很多，需要考虑的情况繁杂，实现起来比较困难。其次，虽然它是最柔性，最灵活和性能最高的，但是事务的原子性和一致性是最弱的，因为这种解决方案是以大家都不出错为前提的。

用到的操作：可查询操作、幂等操作

方案特点

    • 兼容所有实现JMS标准的MQ中间件
    • 确保业务数据可靠的前提下，实现业务数据的最终一致（理想状态下基本是准实时一致）


实现

    • 业务处理服务在业务事务提交前，向实时消息服务请求发送消息，实时消息服务只记录消息数据，而不真正发送。业务处理服务在业务事务提交后，向实时消息服务确认 发送。只有在得到确认发送指令后，实时消息服务才真正发送

消息

    • 业务处理服务在业务事务回滚后，向实时消息服务取消发送。消息状态确认系统定期 找到未确认发送或回滚发送的消息，向业务处理服务询问消息状态，业务处理服务根 据消息ID或消息内容确定该消息是否有效

约束

    • 被动方的处理结果不影响主动方的处理结果， 被动方的消息处理操作是幂等操作

成本

    • 可靠消息系统建设成本
    • 一次消息发送需要两次请求，业务处理服务需实现消息状态回查接口

优点、适用范围
    
    • 消息数据独立存储、独立伸缩，降低业务系统与消息系统间的耦合
    • 对最终一致性时间敏感度较高，降低业务被动方实现成本
    1.独立部署，独立伸缩（扩展性）
    2.兼容所有实现JMS标准的MQ中间件
    3.降低业务系统与消息系统间的耦合性
    4.可实现数据可靠的前提下确保最终一致性


#####TCC方案

>TCC的实现方式优势在于：没有项目XA协议那样，把分布的资源统一管理，这就使得分布的资源不会被加锁，从而提高整体的吞吐量，所以这种分布式事务的解决方案，在性能和吞吐量要求高的应用使用的还是比较多的。而不足之处则在于对应用的侵入性非常强，业务逻辑的每个分支都需要实现try、confirm、cancel三个操作。此外，其实现难度也比较大，需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。同时，confirm和cancel接口还要考虑幂等性的问题，因为confirm和cancel有可能会被多次调用。

用到的操作

    • TCC操作、幂等操作、可补偿操作、可查询操作

方案特点
    • 不与具体的服务框架耦合（在RPC架构中通用）
    • 位于业务服务层，而非资源层 • 可以灵活选择业务资源的锁定粒度
    • TCC里对每个服务资源操作的是本地事务，数据被lock的时间短，可扩展性好（可以说是为独立部署的 SOA服务而设计的）

实现

    • 一个完整的业务活动由一个主业务服务与若干从业务服务组成
    • 主业务服务负责发起并完成整个业务活动
    • 从业务服务提供TCC型业务操作
    • 业务活动管理器控制业务活动的一致性，它登记业务活动中的操作， 并在 业务活动提交时确认所有的TCC型操作的confirm操作，在业务活动取消 时调用所有TCC型操作的cancel操作

成本
    • 实现TCC操作的成本
    • 业务活动结束时confirm或cancel操作的执行成本
    • 业务活动日志成本

优点、适用范围
    • 强隔离性、严格一致性要求的业务活动 • 适用于执行时间较短的业务（比如处理账户、收费等业务）
    1.不与具体的服务框架耦合
    2.位于业务服务层，而非资源层
    3.可以灵活选择业务资源的锁定粒度
    4.适用于强隔离性，严格一致性要求的业务场景
    5.适用于业务执行时间较短的业务

#####最大努力通知型方案

用到的操作：可查询操作

方案特点   

    • 业务活动的主动方在完成业务处理后，向业务活动被动方发送通知消息（允许消息丢失）
    • 主动方可以设置时间阶梯型通知规则，在通知失败后按规则重复通知，直到通知N次后不再通知
    • 主动方提供校对查询接口给被动方按需校对查询，用于恢复丢失的业务消息

实现

    • 业务活动的主动方，在完成业务处理之后，向业务活动的被动方发送消息， 允许消息丢失。
    • 业务活动的被动方根据定时策略，向业务活动主动方查询，恢复丢失的业 务消息。

约束：被动方的处理结果不影响主动方的处理结果

成本：业务查询与校对系统的建设成本

适用范围：对业务最终一致性的时间敏感度低，跨企业的业务活动   

按规律进行通知，不保证数据一定能通知成功，但会提供可查询操作接口进行核对

##### XA方案

>XA是由X/Open组织提出的分布式事务的规范。 XA规范主要定义了(全局)事务管理器(TM)和(局 部)资源管理器(RM)之间的接口。主流的关系型 数据库产品都是实现了XA接口的。     

>XA接口是双向的系统接口，在事务管理器 （TM）以及一个或多个资源管理器（RM）之 间形成通信桥梁。      

>XA之所以需要引入事务管理器是因为，在分布 式系统中，从理论上讲两台机器理论上无法达 到一致的状态，需要引入一个单点进行协调。      

>由全局事务管理器管理和协调的事务，可以跨 越多个资源（如数据库或JMS队列）和进程。 全局事务管理器一般使用 XA 二阶段提交协议 与数据库进行交互。    

>资源管理器（resource manager）：用来管理系统资源，是通向事务资源的途径。数据库就是一种资源管理器。资源管理还应该具有管理事务提交或回滚的能力。    

>事务管理器（transaction manager）：事务管理器是分布式事务的核心管理者。事务管理器与每个资源管理器（resource manager）进行通信，协调并完成事务的处理。事务的各个分支由唯一命名进行标识

>XA分布式事务协议的工作原理是：把各个微服务中的本地资源交给一个统一的事务管理器管理，事务管理器可以看做是事务协调者的角色（coordinator），各个本地资源管理器可以看做是事务参与者的角色（partcipant）。各个事务参与者之间不能直接通讯，而是通过事务协调者间接通讯
 



